<!DOCTYPE html><html lang="zh-CN" data-default-color-scheme="auto"><head><meta charset="UTF-8"><link rel="apple-touch-icon" sizes="76x76" href="/img/pag.png"><link rel="icon" href="/img/pag.png"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=5,shrink-to-fit=no"><meta http-equiv="x-ua-compatible" content="ie=edge"><meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests"><meta name="theme-color" content="#2f4154"><meta name="author" content="zzh"><meta name="keywords" content=""><meta name="description" content="老项目，待更新or抛弃   利用HashMap模拟数据库，储存用户数据 涉及io流，多线程，网络编程等技术 服务端与客户端分离 项目框架设计    1.需求分析 用户登录 拉取用户在线列表 无异常推出客户端，服务端 私聊消息（包括离线） 群发消息（包括离线）    2.整体思路与刨析 客户端与服务端通过Message对象双向传输，其中MessagesType区别业务逻辑 一个用户单独占有一条独立"><meta property="og:type" content="article"><meta property="og:title" content="多用户即时通讯系统"><meta property="og:url" content="http://example.com/2024/03/10/%E5%A4%9A%E7%94%A8%E6%88%B7%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/index.html"><meta property="og:site_name" content="箱庭"><meta property="og:description" content="老项目，待更新or抛弃   利用HashMap模拟数据库，储存用户数据 涉及io流，多线程，网络编程等技术 服务端与客户端分离 项目框架设计    1.需求分析 用户登录 拉取用户在线列表 无异常推出客户端，服务端 私聊消息（包括离线） 群发消息（包括离线）    2.整体思路与刨析 客户端与服务端通过Message对象双向传输，其中MessagesType区别业务逻辑 一个用户单独占有一条独立"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://example.com/img/%E5%A4%9A%E7%94%A8%E6%88%B7%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/b373bc7ba3f99ac4350433709637bc4f.png"><meta property="article:published_time" content="2024-03-10T09:13:53.000Z"><meta property="article:modified_time" content="2024-03-10T11:40:28.486Z"><meta property="article:author" content="zzh"><meta property="article:tag" content="java"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="http://example.com/img/%E5%A4%9A%E7%94%A8%E6%88%B7%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/b373bc7ba3f99ac4350433709637bc4f.png"><meta name="referrer" content="no-referrer-when-downgrade"><title>多用户即时通讯系统 - 箱庭</title><link rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css"><link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css"><link rel="stylesheet" href="/css/main.css"><link id="highlight-css" rel="stylesheet" href="/css/highlight.css"><link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css"><script id="fluid-configs">var Fluid=window.Fluid||{};Fluid.ctx=Object.assign({},Fluid.ctx);var CONFIG={hostname:"example.com",root:"/",version:"1.9.5",typing:{enable:!0,typeSpeed:75,cursorChar:"_",loop:!1,scope:["home"]},anchorjs:{enable:!0,element:"h1,h2,h3,h4,h5,h6",placement:"left",visible:"hover",icon:""},progressbar:{enable:!0,height_px:3,color:"#29d",options:{showSpinner:!1,trickleSpeed:100}},code_language:{enable:!0,default:"TEXT"},copy_btn:!0,image_caption:{enable:!0},image_zoom:{enable:!0,img_url_replace:["",""]},toc:{enable:!0,placement:"right",headingSelector:"h1,h2,h3,h4",collapseDepth:2},lazyload:{enable:!0,loading_img:"/img/loading.gif",onlypost:!1,offset_factor:2},web_analytics:{enable:!0,follow_dnt:!0,baidu:null,google:{measurement_id:null},tencent:{sid:null,cid:null},woyaola:null,cnzz:null,leancloud:{app_id:null,app_key:null,server_url:null,path:"window.location.pathname",ignore_local:!1}},search_path:"/local-search.xml",include_content_in_search:!0};if(CONFIG.web_analytics.follow_dnt){var dntVal=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack;Fluid.ctx.dnt=dntVal&&(dntVal.startsWith("1")||dntVal.startsWith("yes")||dntVal.startsWith("on"))}</script><script src="/js/utils.js"></script><script src="/js/color-schema.js"></script><script async>Fluid.ctx.dnt||Fluid.utils.createScript("https://www.googletagmanager.com/gtag/js?id=",(function(){function a(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],a("js",new Date),a("config","")}))</script><meta name="generator" content="Hexo 6.3.0"></head><body><header><div class="header-inner" style="height:70vh"><nav id="navbar" class="navbar fixed-top navbar-expand-lg navbar-dark scrolling-navbar"><div class="container"><a class="navbar-brand" href="/"><strong>子恒的小窝</strong> </a><button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><div class="animated-icon"><span></span><span></span><span></span></div></button><div class="collapse navbar-collapse" id="navbarSupportedContent"><ul class="navbar-nav ml-auto text-center"><li class="nav-item"><a class="nav-link" href="/"><i class="iconfont icon-home-fill"></i> <span>首页</span></a></li><li class="nav-item"><a class="nav-link" href="/archives/"><i class="iconfont icon-archive-fill"></i> <span>归档</span></a></li><li class="nav-item"><a class="nav-link" href="/categories/"><i class="iconfont icon-category-fill"></i> <span>分类</span></a></li><li class="nav-item"><a class="nav-link" href="/tags/"><i class="iconfont icon-tags-fill"></i> <span>标签</span></a></li><li class="nav-item"><a class="nav-link" href="/about/"><i class="iconfont icon-user-fill"></i> <span>关于</span></a></li><li class="nav-item" id="search-btn"><a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search"><i class="iconfont icon-search"></i></a></li><li class="nav-item" id="color-toggle-btn"><a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle"><i class="iconfont icon-dark" id="color-toggle-icon"></i></a></li></ul></div></div></nav><div id="banner" class="banner" parallax="true" style="background:url(/img/default.png) no-repeat center center;background-size:cover"><div class="full-bg-img"><div class="mask flex-center" style="background-color:rgba(0,0,0,.3)"><div class="banner-text text-center fade-in-up"><div class="h2"><span id="subtitle">多用户即时通讯系统</span></div><div class="mt-3"><span class="post-meta mr-2"><i class="iconfont icon-author" aria-hidden="true"></i> zzh </span><span class="post-meta"><i class="iconfont icon-date-fill" aria-hidden="true"></i> <time datetime="2024-03-10 17:13" pubdate>2024年3月10日 下午</time></span></div><div class="mt-1"><span class="post-meta mr-2"><i class="iconfont icon-chart"></i> 2.1k 字 </span><span class="post-meta mr-2"><i class="iconfont icon-clock-fill"></i> 18 分钟 </span><span id="busuanzi_container_page_pv" style="display:none"><i class="iconfont icon-eye" aria-hidden="true"></i> <span id="busuanzi_value_page_pv"></span> 次</span></div></div></div></div></div></div></header><main><div class="container-fluid nopadding-x"><div class="row nomargin-x"><div class="side-col d-none d-lg-block col-lg-2"></div><div class="col-lg-8 nopadding-x-md"><div class="container nopadding-x-md" id="board-ctn"><div id="board"><article class="post-content mx-auto"><h1 id="seo-header">多用户即时通讯系统</h1><p class="note note-info">本文最后更新于：1 小时前</p><div class="markdown-body"><blockquote><p>老项目，待更新or抛弃</p></blockquote><ul><li>利用HashMap模拟数据库，储存用户数据</li><li>涉及io流，多线程，网络编程等技术</li><li>服务端与客户端分离</li><li>项目框架设计</li></ul><br><h1 id="1-需求分析"><a href="#1-需求分析" class="headerlink" title="1.需求分析"></a>1.需求分析</h1><ol><li>用户登录</li><li>拉取用户在线列表</li><li>无异常推出客户端，服务端</li><li>私聊消息（包括离线）</li><li>群发消息（包括离线）</li></ol><br><h1 id="2-整体思路与刨析"><a href="#2-整体思路与刨析" class="headerlink" title="2.整体思路与刨析"></a>2.整体思路与刨析</h1><ul><li>客户端与服务端通过Message对象双向传输，其中MessagesType区别业务逻辑</li><li>一个用户单独占有一条独立的线程</li><li>利用集合对多个线程进行管理</li><li>使用对象流作为传输工具</li></ul><br><p><img src="/../img/%E5%A4%9A%E7%94%A8%E6%88%B7%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E7%B3%BB%E7%BB%9F/b373bc7ba3f99ac4350433709637bc4f.png" srcset="/img/loading.gif" lazyload></p><br><h1 id="3-功能实现"><a href="#3-功能实现" class="headerlink" title="3.功能实现"></a>3.功能实现</h1><blockquote><p>在框架设计搭建起来之后，后续很多操作都很容易实现，无非就是根据MessageType的类型作用不同的业务逻辑</p><p>User.java：用户类。除了账号密码，还有一个用于接受来自其他人发的群发消息的Message集合</p><p>Message.java：消息类。拥有发送者，接收者，内容，发送时间，消息类型</p><p>MessageType.java：消息类型类。存放的是变量，用于区别消息的类型，包括登陆，消息内容，退出等</p><p>Thread_XX.java：线程类。是客户端与服务器通讯的线程，掌握有socket，同时对服务器（客户端）发送（接收）消息</p></blockquote><br><h2 id="3-1用户登录"><a href="#3-1用户登录" class="headerlink" title="3.1用户登录"></a>3.1用户登录</h2><blockquote><p>用户名和密码是已经在服务端写好的死数据</p><p>QQView.java：展示界面的地方，也是用户第一面</p><p>UserClientService.java：客户端处理业务逻辑的地方，包括连接服务器，验证登录，起线程等</p></blockquote><p><strong>客户端</strong></p><ol><li>新建一个user，将用户输入的账号和密码通过socket传入服务端</li><li>根据MessageType判断登录是否成功</li><li>登录成功则单独起一个线程并存入集合，重复循环等待来自服务端的消息</li></ol><p><strong>服务端</strong></p><ol><li>判断从服务端传来的数据，将结果打包成Message返回</li><li>起线程，存入集合，同服务端同步保持通讯</li></ol><br><h2 id="3-2拉取用户在线列表"><a href="#3-2拉取用户在线列表" class="headerlink" title="3.2拉取用户在线列表"></a>3.2拉取用户在线列表</h2><blockquote><p>在线用户在服务端的线程管理集合中有对应的线程，可以根据这点获取在线用户</p><p>QQQService.java：服务端处理业务逻辑的地方，包括数据的初始化，监听端口起线程等</p></blockquote><p><strong>客户端</strong></p><ol><li>新建Message，设置Type，向服务器请求</li><li>拿到数据后spil（）方法解析字符串得到在线用户列表</li></ol><p><strong>服务端</strong></p><ol><li>用户线程中，收到来自客户端的请求后遍历线程集合取得userId</li><li>将结果拼接得到字符串后new Message，设置type，发送给客户端</li></ol><br><h2 id="3-3无异常退出"><a href="#3-3无异常退出" class="headerlink" title="3.3无异常退出"></a>3.3无异常退出</h2><blockquote><p>java的主线程结束，并不会结束其他的线程</p><p>安全退出方式有很多种，此处采用的是走完所有线程的方式自然退出</p></blockquote><p><strong>客户端</strong></p><ol><li>new Message，设置type，发送消息，结束循环</li></ol><p><strong>服务端</strong></p><ol><li>收到消息，线程集合中remove本条，结束循环</li></ol><br><h2 id="3-4私聊"><a href="#3-4私聊" class="headerlink" title="3.4私聊"></a>3.4私聊</h2><blockquote><p>难点在于实现离线消息</p><p>对方离线的情况下只能将数据保存在服务端，同时需要考虑多个用户发送多条留言的情况</p><p>利用<code>ConcurrentHashMap&lt;String, ArrayList&lt;Message&gt;&gt;</code>存放所有的离线消息<code>k = getter</code>, <code>v = Message</code></p><p>在此处因为数组集合是引用变量而不是值传递且数据公共踩很多坑</p><p>用户上线后则展示一遍留言，默认代表用户已读且处理，下次登陆不会展示之前的留言，下群发消息同样如此，暂时没做聊天记录</p></blockquote><p><strong>客户端</strong></p><ol><li><p>发送or收到</p><p>发送：newMes，设置sender，getter，time，type，打包发送给服务端。</p><p>收到：在线的情况下直接在线程中get</p></li></ol><p><strong>服务端</strong></p><ol><li><p>收到来自客户端的mes后判断getter是否在线</p><p>根据线程集合中判断来自客户端中的mes是否含有getter，拥有则在线，服务器直接转发来自客户端的mes</p></li><li><p>getter不在线的情况</p><p>首先在服务端创建<code>ConcurrentHashMap&lt;String, ArrayList&lt;Message&gt;&gt;</code>集合存放所有的离线消息 ，其中<code>k = getter</code> , <code>v = ArrayList&lt;Message&gt;</code>，它是一个static公共变量，因此必须依靠k，来进行增删改查。</p><p>sender这边来讲，可以将消息抛给服务器的集合中暂存。每个getter应该有相同的ArrayList，可以根据集合中是否有getter来选择是new ArrayList还是直接put。不可将所有的mes都存入一个ArrayList。</p><p>getter在上线起线程后，对离线消息进行处理、重发给客户端，处理好之后删除在集合中的记录。</p><br></li></ol><h2 id="3-5群发"><a href="#3-5群发" class="headerlink" title="3.5群发"></a>3.5群发</h2><blockquote><p>个人认为难点在于在哪储存这个离线的群发讯息。</p><p>一开始想把它放入服务器的公共集合中，根据k&#x3D;“GROUP”来区别于私聊消息，但是后面发现不知用户如何对群发消息的已读做判断</p><p>不同用户对同一个mes有不同的处理方法，不应该吧mes放在同一个公共变量池，或者说不应该因为一个用户对这个公共变量池进行改动从而影响其他用用户</p><p>因此我把群发消息的储存写在了user对象里面，每个user有属于自己的mes，用ArrayList进行保存</p><p>此处同样因为集合的不恰当copy和操作埋了好多坑</p></blockquote><p><strong>客户端</strong></p><ol><li><p>发送or收到</p><p>发送：newMes，设置sender，getter，time，type，打包发送给服务端。</p><p>收到：在线的情况下直接在线程中get</p></li></ol><p><strong>服务端</strong></p><ol><li><p>找出所有在线的用户</p><p>思路类似列出在线客户功能，在线则直接转发</p></li><li><p>对于不在线的用户</p><p>将mes交给user的集合储存，下次登陆查询是否有消息。传递展示后清除</p></li></ol><br><h1 id="4-源码"><a href="#4-源码" class="headerlink" title="4.源码"></a>4.源码</h1></div><hr><div><div class="post-metas my-3"><div class="post-meta mr-3 d-flex align-items-center"><i class="iconfont icon-category"></i> <span class="category-chains"><span class="category-chain"><a href="/categories/%E5%AD%A6%E4%B9%A0/" class="category-chain-item">学习</a> <span>></span> <a href="/categories/%E5%AD%A6%E4%B9%A0/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a></span></span></div><div class="post-meta"><i class="iconfont icon-tags"></i> <a href="/tags/java/" class="print-no-link">#java</a></div></div><div class="post-prevnext my-3"><article class="post-prev col-6"><a href="/2024/03/10/JDK7%E4%B8%8EJDK8-HashMap%E6%BA%90%E7%A0%81%E5%88%A8%E6%9E%90/" title="JDK7与JDK8-HashMap源码刨析~"><i class="iconfont icon-arrowleft"></i> <span class="hidden-mobile">JDK7与JDK8-HashMap源码刨析~</span> <span class="visible-mobile">上一篇</span></a></article><article class="post-next col-6"><a href="/2024/03/04/%E5%AD%A6%E4%B9%A0%E6%97%A5%E5%BF%97/" title="学习日志"><span class="hidden-mobile">学习日志</span> <span class="visible-mobile">下一篇</span> <i class="iconfont icon-arrowright"></i></a></article></div></div><article id="comments" lazyload><div id="valine"></div><script type="text/javascript">Fluid.utils.loadComments("#valine",(function(){Fluid.utils.createScript("https://lib.baomitu.com/valine/1.5.1/Valine.min.js",(function(){var i=Object.assign({appId:"pAMB2w8iZ0dGgDjqXTDPwmSN-gzGzoHsz",appKey:"wGSfk5DAXSATlDCQopSwETpU",path:"window.location.pathname",placeholder:null,avatar:"retro",meta:["nick","mail","link"],requiredFields:[],pageSize:10,lang:"zh-CN",highlight:!1,recordIP:!1,serverURLs:"",emojiCDN:null,emojiMaps:null,enableQQ:!1},{el:"#valine",path:window.location.pathname});new Valine(i),Fluid.utils.waitElementVisible("#valine .vcontent",()=>{var i="#valine .vcontent img:not(.vemoji)";Fluid.plugins.imageCaption(i),Fluid.plugins.fancyBox(i)})}))}))</script><noscript>Please enable JavaScript to view the comments</noscript></article></article></div></div></div><div class="side-col d-none d-lg-block col-lg-2"><aside class="sidebar" style="margin-left:-1rem"><div id="toc"><p class="toc-header"><i class="iconfont icon-list"></i> <span>目录</span></p><div class="toc-body" id="toc-body"></div></div></aside></div></div></div><a id="scroll-top-button" aria-label="TOP" href="#" role="button"><i class="iconfont icon-arrowup" aria-hidden="true"></i></a><div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable modal-lg" role="document"><div class="modal-content"><div class="modal-header text-center"><h4 class="modal-title w-100 font-weight-bold">搜索</h4><button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button></div><div class="modal-body mx-3"><div class="md-form mb-5"><input type="text" id="local-search-input" class="form-control validate"> <label data-error="x" data-success="v" for="local-search-input">关键词</label></div><div class="list-group" id="local-search-result"></div></div></div></div></div></main><footer><div class="footer-inner"><div class="footer-content"><a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a></div><div class="statistics"><span id="busuanzi_container_site_pv" style="display:none">总访问量 <span id="busuanzi_value_site_pv"></span> 次 </span><span id="busuanzi_container_site_uv" style="display:none">总访客数 <span id="busuanzi_value_site_uv"></span> 人</span></div></div></footer><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script>NProgress.configure({showSpinner:!1,trickleSpeed:100}),NProgress.start(),window.addEventListener("load",(function(){NProgress.done()}))</script><script src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js"></script><script src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js"></script><script src="/js/events.js"></script><script src="/js/plugins.js"></script><script src="/js/img-lazyload.js"></script><script>Fluid.utils.createScript("https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js",(function(){var t=jQuery("#toc");if(0!==t.length&&window.tocbot){var i=jQuery("#board-ctn").offset().top;window.tocbot.init(Object.assign({tocSelector:"#toc-body",contentSelector:".markdown-body",linkClass:"tocbot-link",activeLinkClass:"tocbot-active-link",listClass:"tocbot-list",isCollapsedClass:"tocbot-is-collapsed",collapsibleClass:"tocbot-is-collapsible",scrollSmooth:!0,includeTitleTags:!0,headingsOffset:-i},CONFIG.toc)),t.find(".toc-list-item").length>0&&t.css("visibility","visible"),Fluid.events.registerRefreshCallback((function(){if("tocbot"in window){tocbot.refresh();var t=jQuery("#toc");if(0===t.length||!tocbot)return;t.find(".toc-list-item").length>0&&t.css("visibility","visible")}}))}}))</script><script src="https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js"></script><script>Fluid.plugins.codeWidget()</script><script>Fluid.utils.createScript("https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js",(function(){window.anchors.options={placement:CONFIG.anchorjs.placement,visible:CONFIG.anchorjs.visible},CONFIG.anchorjs.icon&&(window.anchors.options.icon=CONFIG.anchorjs.icon);var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(window.anchors.options.class="anchorjs-link-left"),window.anchors.add(o.join(", ")),Fluid.events.registerRefreshCallback((function(){if("anchors"in window){anchors.removeAll();var n=(CONFIG.anchorjs.element||"h1,h2,h3,h4,h5,h6").split(","),o=[];for(var s of n)o.push(".markdown-body > "+s.trim());"left"===CONFIG.anchorjs.placement&&(anchors.options.class="anchorjs-link-left"),anchors.add(o.join(", "))}}))}))</script><script>Fluid.utils.createScript("https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js",(function(){Fluid.plugins.fancyBox()}))</script><script>Fluid.plugins.imageCaption()</script><script src="/js/local-search.js"></script><script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/js/boot.js"></script><noscript><div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div></noscript></body></html>